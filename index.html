<!DOCTYPE html>
<meta charset="UTF-8">
<link href="https://fonts.googleapis.com/css?family=Rajdhani&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Lekton&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" rel="stylesheet">
<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link href="css/style.css" rel="stylesheet">
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
<script src="js/modernizr.custom.js"></script>
<style>
    body {
        height: 100%;
        width: 100%;
        margin: 0;
        font-family: 'Lekton', sans-serif;
        overflow: hidden;
    }
    .node circle {
        fill: #fff7f7;
        stroke: #dadada;
        stroke-width: 2px;
    }

    .demo-3 {
        font-family: 'Rajdhani', sans-serif;
    }

    #search, .ui-menu-item-wrapper {
        font-family: 'Rajdhani', sans-serif;
    }

    .textLabel {
        cursor: help;
        opacity: 1;
        transition: all .2s;
    }

    .node text {
        font: 14px sans-serif;
        font-family: 'Lekton', sans-serif;
        fill: #fff7f7;
        font-weight: bolder;
        text-shadow: 2px 2px #4a4a4a;
    }

    .link {
        fill: none;
        stroke: #818181;
        stroke-width: 2px;
    }

    #tooltip-span {
        font-family: 'Rajdhani', sans-serif;
        text-decoration:none;
        position:relative;
        box-shadow: rgba(0, 0, 0, 0.25) 0px 14px 45px, rgba(0, 0, 0, 0.22) 0px 10px 18px;
        border-radius: 2px;
        background: #fff;
        color: #000;
        width: 208px;
        opacity: 0;
        transition: 1s opacity;
        font-size: 14px;
        padding: 0px;
        pointer-events: none;
        z-index: 99999999999999;
    }
    .tooltip span {
        display:none;
    }
    .tooltip:hover span {
        display:block;
        position:fixed;
        overflow:hidden;
    }

    .container {
        display: flex;
        height: 100vh;
        align-content: stretch;
        background-image: linear-gradient(57deg, #464646 0%, #4a4a4a 21%, #909090 100%);
    }
    .container #map {
        flex: 0 0 70%;
        margin: 0 0 0 auto;
        position: sticky !important;
        right: 0;

    }

    #list {
        z-index: 10000000000;
    }

    #universityCourses {
        overflow: auto;
    }

    svg g {
        pointer-events: all;
    }

    .leaflet-fa-markers {
        position: absolute;
        left: 0;
        top: 0;
        display: block;
        text-align: center;
        margin-left: -7px;
        margin-top: -25px;
        width: 15px;
        height: 25px;
    }

    .leaflet-fa-markers .marker-icon-svg {
        position: absolute;
    }

    .leaflet-fa-markers .feature-icon {
        position: absolute;
        font-size: 10px;
        line-height: 0px;
        left: 3px;
        top: 8px;
        display: inline-block;
    }


    #myDiv {
        z-index: 9999999999;
        border: none;
        display: none;
        background: white;
        text-align:justify;
        position: absolute;
        margin: 1em;
        margin-left: 25%;
        padding: 1em;
        width: 50%;
    }
    #myDiv p {
        margin: 15px;
        font-size: 0.917em;
    }

    .closeIcon {
        font-size: 32px;
        text-align: center;
        line-height: 32px;
        border-radius: 50%;
        border: 12px solid transparent;
        background: rgba(255, 255, 255, 1);
        width: 30px;
        height: 30px;
        position: absolute;
        top: -12px;
        right: -12px;
    }
    .closeIcon:hover {
        color: rgba(0, 0, 0, 0.51);
        cursor: pointer;
    }

    #helper {
        position: fixed;
        top: calc(50% - 40px);
        left: calc(50% - 100px);
        width: 200px;
        height: 80px;
        opacity: 1;
        transition: 2s;
    }

    [class$="-legend"] {
        list-style: none;
        cursor: pointer;
        padding-left: 0;
    }

    [class$="-legend"] li {
        display: inline-block;
        padding: 0 5px;
    }

    [class$="-legend"] li.hidden {
        text-decoration: line-through;
    }

    [class$="-legend"] li span {
        border-radius: 5px;
        display: inline-block;
        height: 12px;
        margin-right: 10px;
        width: 12px;
    }

    #mapLegend {
        opacity: 0;
        transition: 1s opacity;
        position: fixed;
        bottom: 12px;
        left: 30%;
        z-index: 999999;
        /*background: rgba(255, 255, 255, 0.71);*/
        padding-left: 12px;
        padding-right: 12px;
        /*border-radius: 50%;*/
    }

    .iframeContainer {
        background: white;
        padding-left: 12px;
        margin-left: 0px;
        padding-right: 0px;
        width: calc(30% + 8px);
        height: 100%;
        position: absolute;
        display: flex;
        flex-flow: column;
    }

    #articleIframe {
        padding: 12px 8px 0px;
        height: 100%;
        /*margin-bottom: -46px;*/
    }

    .selectedSubject {
        background: #ff3c36 !important;
    }

    .ui-helper-hidden-accessible, .ui-autocomplete {
        z-index: 9999999;
    }

    #logoId {
        opacity: 1;
        z-index: 9;
        top: 0;
        left: 0;
        width: 400px;
        background: #ffffffbf;
        pointer-events: none;
        margin-bottom: -20px;
        margin-top: 12px;
    }

    table {
        border-spacing: 0;
        width: 100%;
        border: 1px solid #ddd;
    }

    th {
        cursor: pointer;
    }

    th, td {
        text-align: left;
        padding: 16px;
    }

    tr:nth-child(even) {
        background-color: #f2f2f2
    }

    .collapsible {
        background-color: #777;
        color: white;
        cursor: pointer;
        padding: 18px;
        width: 100%;
        border: none;
        text-align: left;
        outline: none;
        font-size: 15px;
    }

    .active, .collapsible:hover {
        background-color: #555;
    }

    .content {
        padding: 0 18px;
        display: none;
        overflow: hidden;
        background-color: #f1f1f1;
    }

</style>
<body>
<div class="container">
    <div id="tooltip-span" style="position: absolute; top: 112px; left: 372px; opacity: 0;"></div>
    <!--<div id="helper">-->
        <!--<- Fields of studies-->
        <!--<br />-->
        <!--<br />-->
        <!--<hr />-->
        <!--<br />-->
        <!--Where you can study ->-->
    <!--</div>-->
    <div class="iframeContainer">
        <div style="padding-right: 12px">
        <img id="logoId" src="./images/BoS_image_TopLeft-3.svg" alt="Hi-Knowledge â€“ dive into science" draggable="false" style="opacity: 1;">
        <div>
            <div style="padding-left: 14px;padding-right: 14px;">
                <h3  style="color: #437080; font-family: 'Rajdhani', sans-serif; font-weight: 800; margin-bottom: 2px;">mapping scientific disciplines and universities</h3>
                <span style="font-weight: 800;color: #00d2a0;font-size: 14px;font-style: italic;">in Germany</span>
                <p style="color: #437080; font-weight: 800;">Here goes a description of the project. It should be running on 4-5 lines of text, and below here goes a Wikipedia box, where content is loaded dynamically.</p>
                <span style=" color: #437080; font-weight: 800;">contact</span>
            </div>
        </div>
        <div style="
    background: #f1f1f2;
    height: 10px;
    width: calc(100% + 40px);
    padding-top: 4px;
    margin-left: -36px;
    margin-top: 19px;
"></div>
    </div>
        <iframe id="articleIframe" src="https://en.wikipedia.org/wiki/Branches_of_science?printable=yes" frameborder="0" style="width: 100%;display: block;"></iframe>

        <div id="contentWiki" style="display: none">
            <h3 id="universityLocation"></h3>
            <div id="universityCourses"></div>
        </div>
    </div>
    <div class="demo-3 search" style="right: -52px;left: auto;top: 0px;">
        <div class="main clearfix" style="pointer-events: none;">
            <div class="column" style="pointer-events: none;">
                <div class="dl-menuwrapper">
                    <input placeholder="Search Course/ City" type="text" id="search" name="name" style="
    background: transparent;
    border: none;
    width: calc(100% - 50px);
    height: 50px;
    float: left;
    margin: 0px;
    padding: 20px;
    font-size: 16px;
    color: #395970;
    /* width: 100%; */
">
                    <ul class="dl-menu">
                    </ul>
                    <div class="searchButton" style="width: 50px;height: 50px;background: #395970;font: normal normal normal 14px/1 FontAwesome;color: white;float: right;cursor: pointer;"><i class="fas fa-search"></i></div>
                    <div>
                    </div>
                </div><!-- /dl-menuwrapper -->
            </div>
        </div>
    </div>
    <div class="demo-3" style="
    top: 64px;
">
        <!-- Codrops top bar -->
        <div class="main clearfix" style="pointer-events: none;">
            <div class="column" style="pointer-events: none;">
                <div id="dl-menu" class="dl-menuwrapper">
                    <h3 class="dl-header">Select your desired topic</h3>
                    <button class="dl-trigger dl-active">Branches of Science</button>
                    <ul class="dl-menu" id="dl-menu-attach" style="pointer-events: all;">
                    </ul>
                </div><!-- /dl-menuwrapper -->
            </div>
        </div>
    </div><!-- /container -->
    <div id="mapLegend">
        <div id="legend"><ul class="0-legend"><li style="color: #607D93; font-weight: 600" class=""><span style="background-color:#ff3c36; border: 2px solid #607d93; border-radius: 50%;"></span>Exact match</li><li style="color: #607D93; font-weight: 600"><span style="background-color:#00d2a0; border: 2px solid #607d93; border-radius: 50%;"></span>Category match</li></ul></div>
    </div>
    <div id="map">

    </div>
</div>
<script src="//code.jquery.com/jquery-1.12.4.js"></script>
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js"></script>
<script src="js/L.Icon.FontAwesome.js" type="text/javascript"></script>
<script src="data/germany.js" type="text/javascript"></script>
<script src="data/universityLatLng.js" type="text/javascript"></script>
<script src="js/jquery.dlmenu.js"></script>
<script type="text/javascript">
    var data = {}
    var leafCourses = []
    var universities = []
    var lockUnis = false
    var isHighlighted = false
    var HIGHLIGHTCOLOR1 = '#ff3c36'
    var HIGHLIGHTCOLOR2 = '#00d2a0'
    var BACKGROUNDCOLOR1 = '#dadada'
    var BACKGROUNDCOLOR2 = '#fff7f7'
    var MARKERCOLOR = '#607d93'

    var toAddAsterix = ['Natural Sciences', 'Biology', 'Ecology']

    function triggerEvent(el, type){
        if ('createEvent' in document) {
            // modern browsers, IE9+
            var e = document.createEvent('HTMLEvents');
            e.initEvent(type, false, true);
            el.dispatchEvent(e);
        } else {
            // IE 8
            var e = document.createEventObject();
            e.eventType = type;
            el.fireEvent('on'+e.eventType, e);
        }
    }

    function dynamicClick(id) {
        var el = document.getElementById(id);
        triggerEvent(el, 'mousedown')
        triggerEvent(el, 'click')
    }

    function findBranch(el,id) {
        var finalfound;
        function findBranchInData(el, id) {
            if ((el || {}).id === id) {
                finalfound = el
                return el
            } else {
                if (el.children) {
                    var found = false
                    for (var i=0; i<el.children.length; i++) {
                        var l = el.children[i]
                        found = findBranchInData(l, id)
                    }
                }
            }
        }
        findBranchInData(el, id);
        return finalfound
    }

    function findBranchInData(el,id) {
        if ((el || {}).id === id) {
            return el
        } else {
            if (el.children) {
                var found = false
                el.children.forEach(function (l) {
                    found = findBranchInData(l,id)
                    if (found) {
                        return found
                    }
                })
            }
        }
    }

    $( document ).ready(function() {
        var group = L.layerGroup()
        var tooltipSpan = document.getElementById('tooltip-span');

        var southWest = L.latLng(47.654, 2.90),
            northEast = L.latLng(54.785, 14.807),
            bounds = L.latLngBounds(southWest, northEast);

        var map = L.map('map', {
            center:[51.42, 9.60],
            zoom: 18,
            zoomSnap: 0.25,
            maxZoom: 18,
            minZoom: 4,
            // maxBounds: bounds,
            layers: new L.TileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
                zoom: 13
            })
        })
        function areaStyle(feature){
            return {
                fillColor: '#fff',
                weight: 10,
                opacity: 0.7,
                color: '#fff',
                fillOpacity: 0.7
            }
        };

        L.geoJSON(germanyGeojson, {
        style: areaStyle
        }).addTo(map);

        map.fitBounds(bounds)

        function hideUnused(uni) {
            highlightUniversitiesChildren(uni, true)
        }

        // Toggle children on click.
        function click(d, isLeaf, event) {
            if (isLeaf) {
                event.stopPropagation();
                var dataHeight = typeof d.height !== "undefined" ? d.height : d.data.height
                var dataChildren = d.children || d.data.children || (d.parent || {})._children
                var goToRoot = !(d.children || d.data.children) && d.parent.id === "Branches of Science"

                var wikiId = d.data.itemWiki || d.data.data.itemWiki
                var wikiLabel = d.data.itemLabel || d.data.data.itemLabel

                if(!(lockUnis && isHighlighted)) {
                    if (wikiLabel === "Branches of Science") {
                        d3.selectAll(".markerBackground").style("fill", HIGHLIGHTCOLOR2)
                        $("#mapLegend").css("opacity", 1)
                    } else {
                        if (dataHeight !== 0 && (dataChildren || []).length > 0) {
                            $(".leaflet-fa-markers").css("opacity", 0.2)
                            hideUnused(dataChildren)
                            highlightUniversitiesChildren(dataChildren)
                        } else if (goToRoot) {
                            $(".leaflet-fa-markers").css("opacity", 1)
                        } else {
                            var toHighlight = coursesToUniversities[wikiLabel]
                            if (toHighlight && toHighlight.length !== 0) {
                                highlightUniversities(coursesToUniversities[wikiLabel])
                            }
                            else {
                                // highlight all root classes
                                highlightUniversitiesChildren(d.parent.children || d.parent._children)
                            }
                        }
                    }
                    isHighlighted = true
                }
                currentlySelected = d.id
            }
            var contentOpen = $("#myDiv").css("display") === "block"
            $("#helper").css("opacity", 0)
            if (!isLeaf && contentOpen) closeContent()
            // onClickUniversity('2342fc7')
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                if (!d._children) {
                    var wikiId = ((d.data || {}).data || {}).itemWiki
                    if (wikiId) {
                        $("#myDiv").css("height", Math.floor(document.body.offsetHeight * 0.8) + "px")
                        $("#wikiIframe").attr("src",'https://en.wikipedia.org/wiki/' + wikiId + '?printable=yes')
                        var wikiAlreadyOpen = $("#myDiv").css("display") === "block"

                        if (!wikiAlreadyOpen) {
                            $("#articleIframe").css("display","block")
                            $("#contentWiki").css("display","none");
                            slideIn()
                        }
                    }
                }
                d.children = d._children;
                d._children = null;
            }


            // update(d);
        }

        function handleMouseOver(d, event) {
            event.stopPropagation();
            var pathList = event.path.map(function(e) { return e.className })
            if (pathList.indexOf("dl-legend-menu") > -1 || pathList.indexOf("dl-back") > -1) return
            var wikiId = d.data.itemWiki || d.data.data.itemWiki
            var wikiLabel = d.data.itemLabel || d.data.data.itemLabel
            var dataHeight = typeof d.height !== "undefined" ? d.height : d.data.height
            var dataChildren = d.children || d.data.children

            if(!(lockUnis && isHighlighted)) {
                if (wikiLabel === "Branches of Science") {
                    d3.selectAll(".markerBackground").style("fill", HIGHLIGHTCOLOR2)
                    $("#mapLegend").css("opacity", 1)
                } else {
                    if (dataHeight !== 0) {
                        highlightUniversitiesChildren(dataChildren)
                    } else {
                        var toHighlight = coursesToUniversities[wikiLabel]
                        if (toHighlight && toHighlight.length !== 0) {
                            highlightUniversities(coursesToUniversities[wikiLabel])
                        }
                        else {
                            // highlight all root classes
                            highlightUniversitiesChildren(d.parent.children || d.parent._children)
                        }
                    }
                }
                    isHighlighted = true
            }
            currentlySelected = d.id

            d3.select('#myText' + d.id)
                .style('fill-opacity', 0.6)

            var { x, y } = document.getElementById('myDl' + d.id).getBoundingClientRect()
            tooltipSpan.innerHTML = ''
            tooltipSpan.style.top = Math.floor(y/2) + 'px';
            tooltipSpan.style.left = (x - 214) + 'px';
            $.get("https://en.wikipedia.org/api/rest_v1/page/summary/" + wikiId, function( wikiData ) {
                setTimeout(function(){
                    var imgIbj = wikiData.thumbnail
                    var maxTextLength = 250
                    var fullText = wikiData.extract_html.substring(0,maxTextLength)
                    tooltipSpan.innerHTML = (imgIbj ? '<img src="'+ imgIbj.source +'" style="float: right; padding-bottom: 12px; width: 208px;">' : '') + '<div style="width: 200px; padding-left: 12px; padding-right: 12px;">' + fullText + ((fullText.length === maxTextLength) ? '...' : '') + '</div>'
                    tooltipSpan.style.opacity = 1
                }, 100)
            })
        }


        function handleMouseOut(d, event) {
            event.stopPropagation()
            if (!lockUnis) cleanUp()
            currentlySelected = false
            tooltipSpan.style.opacity = 0
            d3.select('#myText' + d.id)
                .style('fill-opacity', 1)
            setTimeout(function () {
                d3.select('#myId' + d.id)
                    .style('fill-opacity', 1)
            }, 200)
        }


        var universityNames = Object.keys(universityLatLng)
        universities = Object.values(universityLatLng).map((el, index) => {
                return {
                    value: "City: " + universityNames[index],
                    name: universityNames[index],
                    latLng: el,
                    id: universityNames[index]
                }
            }
        )

        universities.forEach(university => {
            let marker = L.marker(university.latLng, {
                icon: L.icon.fontAwesome({
                    iconClasses: 'fa fa-university ',
                    markerColor: MARKERCOLOR,
                    markerClass: university.name,
                    iconSize: [20, 40],
                    iconColor: BACKGROUNDCOLOR2
                }),
                value: university.name,
                riseOnHover: true
            });

            marker.on('mouseover',function(ev) {
                var universityId = ev.target.options.value;
                d3.selectAll("#" + universityId).style("fill", HIGHLIGHTCOLOR1)
            });

            marker.bindTooltip(university.name).openTooltip();

            marker.on('click',function(ev) {
                const universityName = ev.target.options.value;
                cityClicked(universityName)
            });

            marker.on('mouseout',function(ev) {
                var universityId = ev.target.options.value;
                d3.selectAll("#" + universityId).style("fill", MARKERCOLOR)
            });

            // Add each marker to the group
            group.addLayer( marker );

            // Save the ID of the marker with it's data
            university.marker_id = group.getLayerId(marker);
        })

        // Add the group to the map
        group.addTo(map);



        // Click handler for handling
        function onClickUniversity(marker_id) {
            let marker = group.getLayer(marker_id);

            // map.panTo( marker.getLatLng() );
        }

        function cityClicked(universityName) {
            $("#universityLocation").html("Universities in " + universityName)
            const wikiAlreadyOpen = $("#myDiv").css("display") === "block"
            $("#articleIframe").css("display","none");
            $("#contentWiki").css("display","block");
            // $("#contentWiki").css("height", Math.floor(document.body.offsetHeight * 0.8) + "px")
            // $("#universityCourses").html("<ul>" + (universitiesToCourses[universityName] || []).map(el => "<li>" + el + "</li>").join("") + "</ul>")

            var uniqueUniversities = [];
            (universitiesToCourses[universityName] || []).forEach(el => {
                if (el[1] && uniqueUniversities.indexOf(el[1].university) === -1) {
                    uniqueUniversities.push(el[1].university)
                }
            })

            $("#universityCourses").html('')
            uniqueUniversities.forEach(uniName => {
                $("#universityCourses").append('<button type="button" class="collapsible">' + uniName + '</button> <div class="content"><table id="' + uniName + '-table"> <tr> <th onclick="sortTable(\'' + uniName + '-table\',0)">Course</th> <th onclick="sortTable(\'' + uniName + '-table\',1)">Language</th> <th onclick="sortTable(\'' + uniName + '-table\',2)">Type</th> </tr>' + (universitiesToCourses[universityName] || []).filter(el => el[1]).map(el => '<tr> <td>' + el[0] + '</td> <td>' + el[1].language + '</td> <td>' + el[1].type + '</td> </tr>').join("")
                    + '</table> </div>')
            })

            if (!wikiAlreadyOpen) {
                slideIn()
            }

            var coll = document.getElementsByClassName("collapsible");
            var i;

            for (i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function() {
                    this.classList.toggle("active");
                    var content = this.nextElementSibling;
                    if (content.style.display === "block") {
                        content.style.display = "none";
                    } else {
                        content.style.display = "block";
                    }
                });
            }
        }


        function slideIn() {
            // Set the effect type
            var effect = 'slide';

            // Set the options for the effect type chosen
            var options = { direction: 'right' };

            // Set the duration (default: 400 milliseconds)
            var duration = 500;

            $('#myDiv').toggle(effect, options, duration);
        };

        function closeContent () {
            $("#articleIframe").css("display","block");
            $("#contentWiki").css("display","none");
            slideIn();
        }

        $(".closeIcon").click(function () {
            closeContent();
        });

        var currentlySelected = false

        window.addEventListener('resize', () => location.href=location.href, {passive: true})
        function makeTree(csv) {

            data = d3.stratify()
                .id(function(d) { return d.itemLabel; })
                .parentId(function(d) { return d.instanceLabel; })
                ([...csv, {itemWiki: "Branches of Science", itemLabel: "Branches of Science", instanceLabel: null}].reduce((unique, o) => {
                    if(!unique.some(obj => obj.itemLabel === o.itemLabel)) {
                        unique.push(o);
                    }
                    return unique;
                },[]));


            // TODO:

            var idIterator = 0
            function buildDropdowns(restOfTree, attachTo, init) {
                if (!restOfTree) return
                var anchorElement = attachTo
                if (!init && restOfTree.children) {
                    var ul = document.createElement("ul");   // Create a <button> element
                    ul.className = "dl-submenu"
                    // ul.innerHTML = '<li class="dl-back"><a href="#">Back</a></li>';                   // Insert text
                    anchorElement.appendChild(ul);
                    anchorElement = ul
                }

                (restOfTree.children || []).forEach(function(child) {
                    var li = document.createElement("li")
                    li.className = "subjectItem"
                    li.dataset.wiki = child.data.itemWiki
                    li.id = "myDl" + child.id  // + idIterator
                    idIterator = idIterator + 1;
                    li.innerHTML = '<a href="#">' + child.id + (toAddAsterix.indexOf(child.id) > -1 ? ' (*)' : '') + '</a>'
                    li.addEventListener("mouseover", function(e){
                        handleMouseOver(child, e)
                    });
                    li.addEventListener("mouseout", function(e){
                        handleMouseOut(child, e)
                    });
                    li.addEventListener("mousedown", function(e){
                        cleanUp()
                        click(child, true, e)
                    });

                    anchorElement.appendChild(li);
                    buildDropdowns(child, li)
                })
            }
            buildDropdowns(data, document.getElementById('dl-menu-attach'), true)

            $( '#dl-menu' ).dlmenu({
                animationClasses : { classin : 'dl-animate-in-2', classout : 'dl-animate-out-2' },
                onLevelClick: function(d,s,e) { clickBranch(false,d,s,e)},
                onLinkClick: function(d,s,e) { clickBranch(true,d,s,e)}
            });
            // d3.nest()
            //     .key(function(d) {return d.instanceLabel; })
            //     .entries(csv);

            return data;
        }

        function clickBranch (isLeaf, elm, name, e) {
            if (e === true) lockUnis = false
            var wikiId =  elm.context.className === "dl-back" ? (((elm || {})[0].parentElement.parentElement.dataset || {}).wiki || "branches_of_science") : (((elm || {})[0] || {}).dataset || {}).wiki
            if (wikiId) {
                $("#articleIframe").attr("src",'https://en.wikipedia.org/wiki/' + wikiId + '?printable=yes')
                $("#articleIframe").css("display","block");
                $("#contentWiki").css("display","none");

            }
            if (isLeaf) {
                $(".selectedSubject").removeClass("selectedSubject")
                $(elm[0]).addClass("selectedSubject")
                lockUnis = true
            }
        }
        var universityMap = {}
        d3.csv("data/outline.csv", function(csv) {
            var treeData = makeTree(csv)

            // Set the dimensions and margins of the diagram
            var margin = {top: 20, right: 90, bottom: 30, left: 190},
                width = document.body.offsetWidth - margin.left - margin.right,
                height = document.body.offsetHeight - margin.top - margin.bottom;

            function collapse(d) {
                if(d.children) {
                    d._children = d.children
                    d._children.forEach(collapse)
                    d.children = null
                }
            }

            function update(source) {
                // Assigns the x and y position for the nodes
                var treeData = treemap(root);

                // Compute the new tree layout.
                var nodes = treeData.descendants(),
                    links = treeData.descendants().slice(1);

                // Normalize for fixed-depth.
                nodes.forEach(function(d){ d.y = d.depth * 200});

                // ****************** Nodes section ***************************

                // Update the nodes...
                var node = svg.selectAll('g.node')
                    .data(nodes, function(d) {return d.id || (d.id = ++i); });

                // Enter any new modes at the parent's previous position.
                var nodeEnter = node.enter().append('g')
                    .attr('class', 'node')
                    .attr("transform", function(d) {
                        if (d.height === 0) {
                            if (!leafCourses.includes(d.data.id)) leafCourses.push(d.data.id)
                        }
                        return "translate(" + source.y0 + "," + source.x0 + ")";
                    })
                    .on('click', click);

                // Add Circle for the nodes
                nodeEnter.append('circle')
                    .attr('class', 'node')
                    .attr('r', 1e-6)
                    .style("fill", function(d) {
                        return d._children ? "lightsteelblue" : "#9b00ff";
                    })  // Get attributes from circleAttrs var
                    .on("mouseenter", handleMouseOverNode)
                    .on("mouseout", handleMouseOutNode);

                // UPDATE
                var nodeUpdate = nodeEnter.merge(node);

                // Transition to the proper position for the node
                nodeUpdate.transition()
                    .duration(duration)
                    .attr("transform", function(d) {
                        return "translate(" + d.y + "," + d.x + ")";
                    });

                // Update the node attributes and style
                nodeUpdate.select('circle.node')
                    .attr('r', 10)
                    .attr('id', function(d) { return "myId"+d.id })
                    .style("fill", function(d) {
                        return d._children ? "rgba(158, 158, 158, 0.4)" : BACKGROUNDCOLOR2;
                    })
                    .attr('cursor', 'pointer');


                // Remove any exiting nodes
                var nodeExit = node.exit().transition()
                    .duration(duration)
                    .attr("transform", function(d) {
                        return "translate(" + source.y + "," + source.x + ")";
                    })
                    .remove();

                // On exit reduce the node circles size to 0
                nodeExit.select('circle')
                    .attr('r', 1e-6);

                // On exit reduce the opacity of text labels
                nodeExit.select('text')
                    .style('fill-opacity', 1e-6);

                // ****************** links section ***************************

                // Update the links...
                var link = svg.selectAll('path.link')
                    .data(links, function(d) { return d.id; });

                // Enter any new links at the parent's previous position.
                var linkEnter = link.enter().insert('path', "g")
                    .attr("class", "link")
                    .attr('d', function(d){
                        var o = {x: source.x0, y: source.y0}
                        return diagonal(o, o)
                    });

                // UPDATE
                var linkUpdate = linkEnter.merge(link);

                // Transition back to the parent element position
                linkUpdate.transition()
                    .duration(duration)
                    .attr('d', function(d){ return diagonal(d, d.parent) });

                // Remove any exiting links
                var linkExit = link.exit().transition()
                    .duration(duration)
                    .attr('d', function(d) {
                        var o = {x: source.x, y: source.y}
                        return diagonal(o, o)
                    })
                    .remove();

                // Store the old positions for transition.
                nodes.forEach(function(d){
                    d.x0 = d.x;
                    d.y0 = d.y;
                });

                // Creates a curved (diagonal) path from parent to the child nodes
                function diagonal(s, d) {
                    path = `M ${s.y} ${s.x}
                    C ${(s.y + d.y) / 2} ${s.x},
                      ${(s.y + d.y) / 2} ${d.x},
                      ${d.y} ${d.x}`

                    return path
                }


                function handleMouseOverNode(d, i, e, event) {
                    d3.select('#myId' + d.id)
                        .style('fill-opacity', 0.2)
                }


                function handleMouseOutNode(d, i, e, event) {
                    tooltipSpan.style.opacity = 0
                    d3.select('#myId' + d.id)
                        .style('fill-opacity', 1)
                    setTimeout(function () {
                        d3.select('#myId' + d.id)
                            .style('fill-opacity', 1)
                    }, 200)
                }
            }
        })

        function highlightUniversities(uArray, secondary, isFromHide) {
            if (!uArray) return
            uArray.forEach(el => {
                try {
                    if (isFromHide) {
                        d3.selectAll("#" + el).style("opacity", 1)
                    } else {
                        d3.selectAll("#" + el).style("background", secondary ? HIGHLIGHTCOLOR2 : HIGHLIGHTCOLOR1)
                        $("#mapLegend").css("opacity", 1)
                    }
                } catch (err) {
                    console.log(err)
                }
            })
        }

        function highlightUniversitiesChildren(children, isFromHide) {
            if (!children) return
            children.forEach((child) => {
                if (child.height === 0) {
                    var wikiLabel = (child.data.data || {}).itemLabel || child.data.itemLabel
                    highlightUniversities(coursesToUniversities[wikiLabel], true, isFromHide)
                }
                else {
                    highlightUniversitiesChildren((child.data || {}).children || child.children, isFromHide)
                }
            })
        }

        function cleanUp() {
            $( ".selectedSubject" ).removeClass("selectedSubject")
            isHighlighted = false
            d3.selectAll(".leaflet-fa-markers").style("background", MARKERCOLOR)
            // d3.selectAll(".markerBackground").style("fill", MARKERCOLOR)
            $("#mapLegend").css("opacity", 0)
        }


        $( "#search" ).autocomplete({
            minLength: 3,
            source: universities.map(function(el) { return { value: el.value, label: el.value }}).concat(courseNames.map(function(el) { return { value: "Course: " + el }}))
        });

        $( "#search" ).on( "autocompleteselect", function( event, ui ) {
            var selectedEl = ui.item.value
            var selectedType = selectedEl.indexOf("Course: ") > -1 ? "co" : "ci"
            var selectedValue = selectedType === "co" ? selectedEl.split("Course: ")[1] : selectedEl.split("City: ")[1]
            console.debug(selectedValue, selectedType);
            // findBranch(data,selectedValue)
            if (selectedType === "co") {
                dynamicClick("myDl" + selectedValue, true)
            } else if (selectedType === "ci") {
                cityClicked(selectedValue)
            }
        })

    })

    function sortTable(tableID, n) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById(tableID);
        switching = true;
        //Set the sorting direction to ascending:
        dir = "asc";
        /*Make a loop that will continue until
        no switching has been done:*/
        while (switching) {
            //start by saying: no switching is done:
            switching = false;
            rows = table.rows;
            /*Loop through all table rows (except the
            first, which contains table headers):*/
            for (i = 1; i < (rows.length - 1); i++) {
                //start by saying there should be no switching:
                shouldSwitch = false;
                /*Get the two elements you want to compare,
                one from current row and one from the next:*/
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
                /*check if the two rows should switch place,
                based on the direction, asc or desc:*/
                if (dir == "asc") {
                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                        //if so, mark as a switch and break the loop:
                        shouldSwitch= true;
                        break;
                    }
                } else if (dir == "desc") {
                    if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                        //if so, mark as a switch and break the loop:
                        shouldSwitch = true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                /*If a switch has been marked, make the switch
                and mark that a switch has been done:*/
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                //Each time a switch is done, increase this count by 1:
                switchcount ++;
            } else {
                /*If no switching has been done AND the direction is "asc",
                set the direction to "desc" and run the while loop again.*/
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
    }
</script>
</body>
