var data={},leafCourses=[],universities=[],lockUnis=!1,isHighlighted=!1,HIGHLIGHTCOLOR1="#ff3c36",HIGHLIGHTCOLOR2="#00d2a0",BACKGROUNDCOLOR2="#fff7f7",MARKERCOLOR="#607d93",canShowTooltip=!1,toAddAsterix=["Natural Sciences","Biology","Ecology","Invasion biology"];function triggerEvent(e,t){var i;"createEvent"in document?((i=document.createEvent("HTMLEvents")).initEvent(t,!1,!0),e.dispatchEvent(i)):((i=document.createEventObject()).eventType=t,e.fireEvent("on"+i.eventType,i))}function dynamicClick(e){var t=document.getElementById(e);triggerEvent(t,"mousedown"),triggerEvent(t,"click")}function findBranchInData(e,t){if((e||{}).id===t)return e;if(e.children){var i=!1;e.children.forEach(function(e){if(i=findBranchInData(e,t))return i})}}function sortTable(e,t){var i,n,a,l,o,s,c,r,d=0;for(i=document.getElementById(e),a=!0,r="asc";a;){for(a=!1,n=i.rows,l=1;l<n.length-1;l++)if(c=!1,o=n[l].getElementsByTagName("TD")[t],s=n[l+1].getElementsByTagName("TD")[t],"asc"==r){if(o.innerHTML.toLowerCase()>s.innerHTML.toLowerCase()){c=!0;break}}else if("desc"==r&&o.innerHTML.toLowerCase()<s.innerHTML.toLowerCase()){c=!0;break}c?(n[l].parentNode.insertBefore(n[l+1],n[l]),a=!0,d++):0==d&&"asc"==r&&(r="desc",a=!0)}}$(document).ready(function(){var e=L.layerGroup(),t=document.getElementById("tooltip-span"),i=L.latLng(47.654,2),n=L.latLng(54.785,14.807),a=L.latLngBounds(i,n),l=L.map("map",{center:[51.42,9.6],zoom:18,zoomSnap:.25,maxZoom:7,minZoom:5,layers:new L.TileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ",zoom:13})});function o(e,t,i){if(t){i.stopPropagation();var n=void 0!==e.height?e.height:e.data.height,a=e.children||e.data.children||(e.parent||{})._children,l=!(e.children||e.data.children)&&"Branches of Science"===e.parent.id,o=(e.data.itemWiki||e.data.data.itemWiki,e.data.itemLabel||e.data.data.itemLabel);if(!lockUnis||!isHighlighted){if("Branches of Science"===o)d3.selectAll(".markerBackground").style("fill",HIGHLIGHTCOLOR2),$("#mapLegend").css("opacity",1);else if(0!==n&&(a||[]).length>0)$(".leaflet-fa-markers").css("opacity",.2),h(a,!0),0===h(a)&&h(e.parent.children||e.parent._children,!0);else if(l)$(".leaflet-fa-markers").css("opacity",1);else{var s=coursesToUniversities[o];if(s&&0!==s.length)f(coursesToUniversities[o]);else 0===h(e.parent.children||e.parent._children)&&h(e.parent.parent.children||e.parent.parent._children)}isHighlighted=!0}e.id}var c="block"===$("#myDiv").css("display");if($("#helper").css("opacity",0),!t&&c&&d(),e.children)e._children=e.children,e.children=null;else{if(!e._children)if(((e.data||{}).data||{}).itemWiki)$("#myDiv").css("height",Math.floor(.8*document.body.offsetHeight)+"px"),"block"===$("#myDiv").css("display")||($("#articleIframe").css("display","block"),$("#articleLink").css("display","block"),$("#contentWiki").css("display","none"),r());e.children=e._children,e._children=null}}L.geoJSON(germanyGeojson,{style:function(e){return{fillColor:"#fff",weight:5,opacity:.7,color:"#fff",fillOpacity:.85}}}).addTo(l),l.fitBounds(a);var s=Object.keys(universityLatLng);function c(e){$("#universityLocation").html("Universities in "+e);const t="block"===$("#myDiv").css("display");$("#articleIframe").css("display","none"),$("#articleLink").css("display","none"),$("#contentWiki").css("display","block");var i=[];(citiesToCourses[e]||[]).forEach(e=>{e[1]&&-1===i.indexOf(e[1].university)&&i.push(e[1].university)}),$("#universityCourses").html(""),i.forEach(e=>{var t=[...new Map((universitiesToCourses[e]||[]).map(e=>[e.name,e])).values()];$("#universityCourses").append('<button type="button" class="collapsible">'+e+'</button> <div class="content"><table id="'+e+'-table"> <tr> <th onclick="sortTable(\''+e+"-table',0)\">Course</th> <th onclick=\"sortTable('"+e+"-table',1)\">Language</th> <th onclick=\"sortTable('"+e+"-table',2)\">Type</th> </tr>"+t.map(e=>'<tr> <td title="'+e.name+'">'+e.name+"</td> <td>"+e.language+"</td> <td>"+e.type+"</td> </tr>").join("")+"</table> </div>")}),t||r();var n,a=document.getElementsByClassName("collapsible");for(n=0;n<a.length;n++)a[n].addEventListener("click",function(){this.classList.toggle("active");var e=this.nextElementSibling;"block"===e.style.display?e.style.display="none":e.style.display="block"})}function r(){$("#myDiv").toggle("slide",{direction:"right"},500)}function d(){$("#articleIframe").css("display","block"),$("#articleLink").css("display","block"),$("#contentWiki").css("display","none"),r()}(universities=Object.values(universityLatLng).map((e,t)=>({value:"City: "+s[t],name:s[t],latLng:e,id:s[t]}))).forEach(t=>{let i=L.marker(t.latLng,{icon:L.icon.fontAwesome({iconClasses:"fa fa-university ",markerColor:MARKERCOLOR,markerClass:t.name,iconSize:[20,40],iconColor:BACKGROUNDCOLOR2}),value:t.name,riseOnHover:!0});i.on("mouseover",function(e){var t=e.target.options.value;d3.selectAll("#"+t).style("fill",HIGHLIGHTCOLOR1)}),i.bindTooltip(t.name).openTooltip(),i.on("click",function(e){c(e.target.options.value)}),i.on("mouseout",function(e){var t=e.target.options.value;d3.selectAll("#"+t).style("fill",MARKERCOLOR)}),e.addLayer(i),t.marker_id=e.getLayerId(i)}),e.addTo(l),$(".closeIcon").click(function(){d()});function u(e){data=d3.stratify().id(function(e){return e.itemLabel}).parentId(function(e){return e.instanceLabel})([...e,{itemWiki:"Branches of Science",itemLabel:"Branches of Science",instanceLabel:null}].reduce((e,t)=>(e.some(e=>e.itemLabel===t.itemLabel)||e.push(t),e),[]));var i='<a class="hiKa" style="color: #607D93; font-weight: 600" target="_blank" href="http://www.hi-knowledge.org"><img class="logoIcon" src="./images/BoS_K_icon.svg" alt="Hi-Knowledge â€“ dive into science" title="Go to Hi-Knowledge" draggable="false"></a>';return function e(n,a,l){if(n){var s=a;if(!l&&n.children){var c=document.createElement("ul");c.className="dl-submenu",s.appendChild(c),s=c}(n.children||[]).forEach(function(n){var a=document.createElement("li");a.className="subjectItem",a.dataset.wiki=n.data.itemWiki,a.id="myDl"+n.id,1;var l=toAddAsterix.indexOf(n.id)>-1;a.innerHTML='<div class="liSubject" href="#">'+(l?i:"")+n.id+"</div>",a.addEventListener("mouseover",function(e){!function(e,i){i.stopPropagation(),canShowTooltip=!0;var n=(i.path||i.composedPath&&i.composedPath()||[]).map(function(e){return e.className});if(!("logoIcon"===i.target.className||n.indexOf("dl-legend-menu")>-1||n.indexOf("dl-back")>-1)){var a=e.data.itemWiki||e.data.data.itemWiki,l=e.data.itemLabel||e.data.data.itemLabel,o=void 0!==e.height?e.height:e.data.height,s=e.children||e.data.children;if(!lockUnis||!isHighlighted){if("Branches of Science"===l)d3.selectAll(".markerBackground").style("fill",HIGHLIGHTCOLOR2),$("#mapLegend").css("opacity",1);else if(0!==o)0===h(s)&&h(e.parent.children||e.parent._children);else{var c=coursesToUniversities[l];c&&0!==c.length?f(coursesToUniversities[l]):0===h(e.parent.children||e.parent._children)&&h(e.parent.parent.children||e.parent.parent._children)}isHighlighted=!0}e.id,d3.select("#myText"+e.id).style("fill-opacity",.6);var{x:r,y:d}=document.getElementById("myDl"+e.id).getBoundingClientRect();t.innerHTML="",t.style.left=r+356+"px",$.get("https://en.wikipedia.org/api/rest_v1/page/summary/"+a,function(e){setTimeout(function(){var i=e.thumbnail,n=e.extract_html.substring(0,250);t.style.opacity=0,t.innerHTML=(i?'<img src="'+i.source+'" style="float: right; padding-bottom: 12px; width: 208px;">':"")+'<div style="width: 200px; padding-left: 12px; padding-right: 12px;">'+n+(250===n.length?"...":"")+"</div>",setTimeout(function(){var e=Math.floor(d),i=document.body.offsetHeight-t.offsetHeight;e<0&&(e=0),e>i&&(e=i),t.style.top=e+"px",canShowTooltip&&(t.style.opacity=1)},100)},100)})}}(n,e)}),a.addEventListener("mouseout",function(e){var i;i=n,e.stopPropagation(),canShowTooltip=!1,lockUnis||p(),!1,t.style.opacity=0,d3.select("#myText"+i.id).style("fill-opacity",1),setTimeout(function(){d3.select("#myId"+i.id).style("fill-opacity",1)},200)}),a.addEventListener("mousedown",function(e){p(),o(n,!0,e)}),s.appendChild(a),e(n,a)})}}(data,document.getElementById("dl-menu-attach"),!0),$("#dl-menu").dlmenu({animationClasses:{classin:"dl-animate-in-2",classout:"dl-animate-out-2"},onLevelClick:function(e,t,i){m(!1,e,t,i)},onLinkClick:function(e,t,i){m(!0,e,t,i)}}),data}function m(e,t,i,n){!0===n&&(lockUnis=!1);var a="dl-back"===t.context.className?((t||{})[0].parentElement.parentElement.dataset||{}).wiki||"branches_of_science":(((t||{})[0]||{}).dataset||{}).wiki;a&&($("#articleIframe").attr("src","https://en.wikipedia.org/wiki/"+a+"?printable=yes"),$("#articleLink").attr("href","https://en.wikipedia.org/wiki/"+a),$("#articleIframe").css("display","block"),$("#articleLink").css("display","block"),$("#contentWiki").css("display","none")),e&&($(".selectedSubject").removeClass("selectedSubject"),$(t[0]).addClass("selectedSubject"),lockUnis=!0)}function f(e,t,i){e&&e.forEach(e=>{try{i?d3.selectAll("#"+e).style("opacity",1):(d3.selectAll("#"+e).style("background",t?HIGHLIGHTCOLOR2:HIGHLIGHTCOLOR1),$("#mapLegend").css("opacity",1))}catch(e){console.log(e)}})}function h(e,t,i){return e?(i=i||0,e.forEach(e=>{if(0===e.height){var n=(e.data.data||{}).itemLabel||e.data.itemLabel,a=coursesToUniversities[n]||[];f(a,!0,t),i+=a.length}else i+=h((e.data||{}).children||e.children,t,i)}),i):0}function p(){$(".selectedSubject").removeClass("selectedSubject"),isHighlighted=!1,d3.selectAll(".leaflet-fa-markers").style("background",MARKERCOLOR)}window.addEventListener("resize",()=>location.href=location.href,{passive:!0}),d3.csv("data/outline.csv",function(e){u(e);var t=20,i=90,n=30,a=190;document.body.offsetWidth,document.body.offsetHeight}),$("#search").autocomplete({minLength:3,source:universities.map(function(e){return{value:e.value,label:e.value}}).concat(courseNames.map(function(e){return{value:"Course: "+e}}))}),$("#search").on("autocompleteselect",function(e,t){var i=t.item.value,n=i.indexOf("Course: ")>-1?"co":"ci",a="co"===n?i.split("Course: ")[1]:i.split("City: ")[1];"co"===n?dynamicClick("myDl"+a,!0):"ci"===n&&c(a)})});